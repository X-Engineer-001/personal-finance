<html>
  <head>
    <script src='js/jquery-2.2.4.min.js'></script>
    <link rel="stylesheet" type="text/css" href='css/bootstrap.min.css' />
    <script src='js/bootstrap.min.js'></script>
    <script src='js/fdb-all.min.js'></script>
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1'>
    <meta charset="UTF-8">
  </head>
  <body>
    <br>
    事項
    <br>
    <br>
    <input type='text' class='form-control' id='recordeventinput'></input>
    <select id='recordeventrecent'>
      <option value='text' id='recordeventrecenttext' selected>選擇最近的事項</option>
    </select>
    <br>
    <br>
    時間
    <br>
    <br>
    <input type='text' style='width:28%;display:inline' class='form-control' id='recordtimeyear'></input><p style='width:5%;display:inline'>年</p>
    <input type='text' style='width:28%;display:inline' class='form-control' id='recordtimemonth'></input><p style='width:5%;display:inline'>月</p>
    <input type='text' style='width:28%;display:inline' class='form-control' id='recordtimeday'></input><p style='width:5%;display:inline'>日</p>
    <button type="button" class="btn btn-default btn-sm btn-block" id='recordtimenow'>套用現在時間</button>
    <br>
    類別
    <br>
    <br>
    <select id='recordtype'>
      <option value="text" id='recordtypetext' selected></option>
      <option value="食">食</option>
      <option value="衣">衣</option>
      <option value="住">住</option>
      <option value="行">行</option>
      <option value="育">育</option>
      <option value="樂">樂</option>
    </select>
    <br>
    <br>
    金額
    <br>
    <br>
    <input type='text' style='width:95%;display:inline' class='form-control' id='recordmoney'></input><p style='width:5%;display:inline'>元</p>
    <br>
    <br>
    <a class="btn btn-default btn-sm" href='index.html' style='width:49%;display:inline-block' id='recordbackbutton'>返回</a>
    <button type="button" class="btn btn-success" style='width:49%;display:inline' id='recordcomplete'>確認</button>
    <script>
      var fdb = new ForerunnerDB();
      var db = fdb.db("DB");
      var collection=db.collection("collection");
      collection.load(function(){
        $("#recordeventrecenttext").append("");
        $("body").on("click","#recordcomplete",function(){
          var years=$('#recordtimeyear').val();
          var months=$('#recordtimemonth').val();
          var monthsdays;
          var leap=(years%4==0&&years%100!=0)||(years%400==0&&years%4000!=0);
          if(months==1){
            monthsdays=31;
          }else if(months==2&&leap){
            monthsdays=60;
          }else if(months==2){
            monthsdays=59;
          }else if(months<=7&&leap){
            monthsdays=60+(months-(months%2)-2)/2*61+(months%2)*31;
          }else if(months<=7){
            monthsdays=59+(months-(months%2)-2)/2*61+(months%2)*31;
          }else if(leap){
            monthsdays=213+(months-((months-1)%2)-7)/2*61+((months-1)%2)*31;
          }else{
            monthsdays=212+(months-((months-1)%2)-7)/2*61+((months-1)%2)*31;
          }
          var days=$('#recordtimeday').val();
          var times=years*365+(years-years%4000)/4000*969+(years%4000-years%400)/400*97+(years%400-years%100)/100*24+(years%100-years%4)/4+monthsdays+days/1;
          collection.insert({event:$('#recordeventinput').val(),year:years,month:months,day:days,type:$('#recordtype').val(),money:$('#recordmoney').val(),time:times});
          $('#recordeventinput').val('');
          $('#recordtimeyear').val('');
          $('#recordtimemonth').val('');
          $('#recordtimeday').val('');
          $('#recordtype').val('');
          $('#recordmoney').val('');
          collection.save();
          var events=collection.find({$distinct:{event:1}},{$limit:5,$aggregate:"event"});
        })
        $("body").on("click","#recordtimenow",function(){
          var date=new Date();
          $('#recordtimeyear').val(date.getFullYear());
          $('#recordtimemonth').val(date.getMonth()+1);
          $('#recordtimeday').val(date.getDate());
          collection.save();
        })
        var events=collection.find({$distinct:{event:1}},{$limit:5,$aggregate:"event"});
        $("body").on("click","#recordeventrecent",function(){
          if($("#recordeventrecent").val()=="text"){
            $("#recordeventrecenttext").remove();
          }
          $('.recordeventrecentevents').remove();
          for(var i=0;i<events.length;i++){
            $('#recordeventrecent').append("<option value="+events[i]+" class='recordeventrecentevents'>"+events[i]+"</option>");
          }
        })
        $("body").on("change","#recordeventrecent",function(){
          var event=$('recordeventrecent').val();
          $('#recordeventinput').val(event);
        })
        $("body").on("click","#recordtype",function(){
          if($("#recordtype").val()=="text"){
            $("#recordtypetext").remove();
          }
        })
      });
    </script>
  </body>
</html>
